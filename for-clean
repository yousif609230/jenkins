import csv
import json
import sys
import os
import math

def convert_csv_to_json(csv_file_path, output_json_base):
    # List to store the data
    data = []
    
    try:
        # Open and read the CSV file
        with open(csv_file_path, 'r') as csv_file:
            # Create CSV reader
            csv_reader = csv.DictReader(csv_file)
            
            # Extract only CIF and email columns for each row
            for row in csv_reader:
                filtered_row = {
                    'cif': row['cif'],
                    'email': row['email']
                }
                data.append(filtered_row)
        
        # Calculate number of files needed (50 records per file)
        records_per_file = 50
        total_files = math.ceil(len(data) / records_per_file)
        
        # Split data into chunks and write to separate files
        for i in range(total_files):
            start_idx = i * records_per_file
            end_idx = min((i + 1) * records_per_file, len(data))
            chunk_data = data[start_idx:end_idx]
            
            # Generate output filename with index
            file_name = f"{output_json_base}_{i+1}.json"
            
            # Write chunk to JSON file without indentation (single line)
            with open(file_name, 'w') as json_file:
                json.dump(chunk_data, json_file, separators=(',', ':'))
            
            print(f"Created file {file_name} with {len(chunk_data)} records")
            
        print(f"\nSuccessfully split data into {total_files} files with {records_per_file} records each")
        
    except FileNotFoundError:
        print(f"Error: The file {csv_file_path} was not found.")
    except KeyError as e:
        print(f"Error: Column {e} not found in CSV file. Please ensure 'cif' and 'email' columns exist in your CSV.")
    except Exception as e:
        print(f"An error occurred: {str(e)}")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python csv_to_json_converter.py input.csv output_base")
        print("Example: python csv_to_json_converter.py data.csv output")
        print("This will create files like output_1.json, output_2.json, etc.")
    else:
        input_csv = sys.argv[1]
        output_base = sys.argv[2]
        convert_csv_to_json(input_csv, output_base)
